###########################################
# Roomba
###########################################
- platform: command_line
  command: "curl -s http://192.168.1.37:8484/api/local/info/mission | jq .ok.cycle | sed -e 's/^\"//' -e 's/\"$//'"
  name: 'Roomba Cycle'

- platform: template
  sensors:
    roomba_cycle_template:
        value_template: >-
          {%- if is_state("sensor.roomba_cycle", "charge") %}
              Docked
          {%- elif is_state("sensor.roomba_cycle", "run") %}
              Running
          {%- elif is_state("sensor.roomba_cycle", "stuck") %}
              Stuck
          {%- elif is_state("sensor.roomba_cycle", "stop") %}
              Stopped
          {%- else %}
              None
          {%- endif %}

- platform: command_line
  command: "curl -s http://192.168.1.37:8484/api/local/info/mission | jq .ok.phase | sed -e 's/^\"//' -e 's/\"$//'"
  name: 'Roomba Phase'

- platform: template
  sensors:
    roomba_phase_template:
        value_template: >-
          {%- if is_state("sensor.roomba_cycle", "charge") %}
              Charging
          {%- elif is_state("sensor.roomba_cycle", "run") %}
              Cleaning
          {%- elif is_state("sensor.roomba_cycle", "stuck") %}
              Stuck
          {%- elif is_state("sensor.roomba_cycle", "stop") %}
              Stopped
          {%- else %}
              None
          {%- endif %}

- platform: command_line
  command: "curl -s http://192.168.1.37:8484/api/local/info/mission | jq .ok.notReady"
  name: 'Roomba NotReady Flag'

- platform: template
  sensors:
    roomba_notready_template:
      value_template: >
        {% if is_state("sensor.roomba_notready_flag", "0") %}
            Ready
        {% elif is_state("sensor.roomba_notready_flag", "1") %}
            Cliff
        {% elif is_state("sensor.roomba_notready_flag", "2") %}
            Wheels Dropped
        {% elif is_state("sensor.roomba_notready_flag", "3") %}
            Left Wheel Dropped
        {% elif is_state("sensor.roomba_notready_flag", "4") %}
            Right Wheel Dropped
        {% elif is_state("sensor.roomba_notready_flag", "7") %}
           Bin Missing
        {% elif is_state("sensor.roomba_notready_flag", "18") %}
           Docking Failed
        {% else %}
           Error
        {% endif %}
          
- platform: command_line
  command: "curl -s http://192.168.1.37:8484/api/local/info/mission | jq .ok.batPct"
  name: 'Roomba Battery'
  unit_of_measurement: '%'
  scan_interval: 60

- platform: command_line
  command: "curl -s http://192.168.1.37:8484/api/local/info/mission | jq .ok.sqft"
  name: 'Roomba Coverage'
  unit_of_measurement: 'sqft'
  scan_interval: 60

- platform: command_line
  command: "curl -s http://192.168.1.37:8484/api/local/info/mission | jq .ok.flags"
  name: 'Roomba Maintenance Flag'
  scan_interval: 60

- platform: template
  sensors:
    roomba_maintenance_template:
      value_template: >
        {% if is_state("sensor.roomba_maintenance_flag", "0") %}
            Ready
        {% elif is_state("sensor.roomba_maintenance_flag", "1") %}
            Bin Full
        {% elif is_state("sensor.roomba_maintenance_flag", "2") %}
            Bin Detached
        {% elif is_state("sensor.roomba_maintenance_flag", "4") %}
            Ready
        {% elif is_state("sensor.roomba_maintenance_flag", "5") %}
            Bin Full
        {% elif is_state("sensor.roomba_maintenance_flag", "6") %}
            Bin Detached
        {% elif is_state("sensor.roomba_maintenance_flag", "12") %}
            Starting
        {% else %}
            n/a
        {% endif %}